name: 'Causal Pipeline test'

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Run pipeline
        run: |
          # Activate our virtual environment once
          source .venv/bin/activate

          # Define the helper function in this shell session.
          run_module() {
            python -m "$1" --config_path "$2"
          }

          # Execute sequential modules.
          run_module corebehrt.main.create_data corebehrt/configs/causal/prepare_and_pretrain/create_data.yaml
          run_module corebehrt.main.prepare_training_data corebehrt/configs/causal/prepare_and_pretrain/prepare_pretrain.yaml
          run_module corebehrt.main.pretrain corebehrt/configs/causal/prepare_and_pretrain/pretrain.yaml

          # Outcomes and cohort selection.
          run_module corebehrt.main.create_outcomes corebehrt/configs/causal/outcomes.yaml
          run_module corebehrt.main.select_cohort corebehrt/configs/causal/select_cohort/select_cohort_exposure.yaml
          run_module corebehrt.main_causal.select_cohort_advanced corebehrt/configs/causal/select_cohort/advanced_extraction.yaml
          run_module corebehrt.main.prepare_training_data corebehrt/configs/causal/finetune/prepare_finetune_exposure.yaml
          run_module corebehrt.main.finetune_cv corebehrt/configs/causal/finetune/finetune_exposure.yaml

          # Causal steps.
          run_module corebehrt.main_causal.calibrate corebehrt/configs/causal/finetune/calibrate.yaml
          run_module corebehrt.main_causal.encode corebehrt/configs/causal/finetune/encode.yaml
          run_module corebehrt.main_causal.train_mlp corebehrt/configs/causal/double_robust/train_mlp.yaml
          run_module corebehrt.main_causal.train_xgb corebehrt/configs/causal/double_robust/train_xgb.yaml
          run_module corebehrt.main_causal.estimate corebehrt/configs/causal/estimate/estimate.yaml

          # Simulated counterfactuals.
          run_module corebehrt.main_causal.simulate corebehrt/configs/causal/simulate.yaml
          run_module corebehrt.main_causal.train_mlp corebehrt/configs/causal/double_robust/train_mlp_simulated.yaml
          run_module corebehrt.main_causal.estimate corebehrt/configs/causal/estimate/estimate_with_true.yaml
