name: 'Causal Pipeline test'

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Run pipeline
        run: |
          # Activate our virtual environment once
          source .venv/bin/activate

          # Execute sequential modules.
          echo "Running create_data"
          python -m corebehrt.main.create_data --config_path corebehrt/configs/causal/prepare_and_pretrain/create_data.yaml
          echo "Running prepare_training_data"
          python -m corebehrt.main.prepare_training_data --config_path corebehrt/configs/causal/prepare_and_pretrain/prepare_pretrain.yaml
          echo "Running pretrain"
          python -m corebehrt.main.pretrain --config_path corebehrt/configs/causal/prepare_and_pretrain/pretrain.yaml

          # Outcomes and cohort selection.
          echo "Running create_outcomes"
          python -m corebehrt.main.create_outcomes --config_path corebehrt/configs/causal/outcomes.yaml
          echo "Running select_cohort"
          python -m corebehrt.main.select_cohort --config_path corebehrt/configs/causal/select_cohort/select_cohort_exposure.yaml
          echo "Running select_cohort_advanced"
          python -m corebehrt.main_causal.select_cohort_advanced --config_path corebehrt/configs/causal/select_cohort/advanced_extraction.yaml
          echo "Running prepare_finetune_data"
          python -m corebehrt.main.prepare_training_data --config_path corebehrt/configs/causal/finetune/prepare_finetune_exposure.yaml
          echo "Running finetune"
          python -m corebehrt.main.finetune_cv --config_path corebehrt/configs/causal/finetune/finetune_exposure.yaml

          # Causal steps.
          echo "Running calibrate"
          python -m corebehrt.main_causal.calibrate --config_path corebehrt/configs/causal/finetune/calibrate.yaml
          echo "Running encode"
          python -m corebehrt.main_causal.encode --config_path corebehrt/configs/causal/finetune/encode.yaml
          echo "Running train_mlp"
          python -m corebehrt.main_causal.train_mlp --config_path corebehrt/configs/causal/double_robust/train_mlp.yaml
          echo "Running train_xgb"
          python -m corebehrt.main_causal.train_xgb --config_path corebehrt/configs/causal/double_robust/train_xgb.yaml
          echo "Running estimate"
          python -m corebehrt.main_causal.estimate --config_path corebehrt/configs/causal/estimate/estimate.yaml

          # Simulated counterfactuals.
          echo "Running simulate"
          python -m corebehrt.main_causal.simulate --config_path corebehrt/configs/causal/simulate.yaml
          echo "Running train_mlp_simulated"
          python -m corebehrt.main_causal.train_mlp --config_path corebehrt/configs/causal/double_robust/train_mlp_simulated.yaml
          echo "Running estimate_with_true"
          python -m corebehrt.main_causal.estimate --config_path corebehrt/configs/causal/estimate/estimate_with_true.yaml
