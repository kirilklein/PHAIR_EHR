## Confounders: harmonized with cohort logic and time windows
## Notes:
## - Medication windows: 60 days
## - Labs (values): HbA1c 90d, eGFR 180d, lipids 365d
## - Chronic diagnoses (history): 5 years (1826d)
## - Outcomes: no start_days (to be evaluated post-index)
## - Kept original "diabetes" block but added "type2_diabetes" (recommended)

criteria_definitions:

  ########################################
  # Exposure class (SGLT2 inhibitors)
  ########################################
  dapagliflozin:
    codes:
      - ^(?:M|RM)/A10BK01.*
      - ^(?:M|RM)/A10BD15.*
      - ^(?:M|RM)/A10BD21.*
      - ^(?:M|RM)/A10BD25.*
      - ^(?:M|RM)/A10BX09.*
    start_days: -60
  canagliflozin:
    codes:
      - ^(?:M|RM)/A10BK02.*
      - ^(?:M|RM)/A10BD16.*
      - ^(?:M|RM)/A10BX11.*
    start_days: -60
  empagliflozin:
    codes:
      - ^(?:M|RM)/A10BK03.*
      - ^(?:M|RM)/A10BD19.*
      - ^(?:M|RM)/A10BD20.*
      - ^(?:M|RM)/A10BD27.*
      - ^(?:M|RM)/A10BX12.*
    start_days: -60
  ertugliflozin:
    codes:
      - ^(?:M|RM)/A10BK04.*
      - ^(?:M|RM)/A10BD23.*
      - ^(?:M|RM)/A10BD24.*
    start_days: -60

  # Class wrapper (recommended for modeling)
  sglt2_inhibitors:
    expression: dapagliflozin | canagliflozin | empagliflozin | ertugliflozin
    start_days: -60

  ########################################
  # Diabetes (aligned with cohort)
  ########################################
  # Original broad definitions (kept for compatibility)
  diabetes_icd10:
    codes:
      - ^(?:D|RD)/DE10.*
      - ^(?:D|RD)/DE11.*
      - ^(?:D|RD)/DE12.*
      - ^(?:D|RD)/DE13.*
      - ^(?:D|RD)/DE14.*
      - ^(?:D|RD)/DH360.*
    start_days: -1826
  icd10_do24:
    codes:
      - ^(?:D|RD)/DO24.*
    start_days: -1826
  icd10_do244:
    codes:
      - ^(?:D|RD)/DO244.*
    start_days: -1826
  icd10_do24_excluding_do244:
    expression: icd10_do24 & ~icd10_do244
  diabetes_atc_antihyperglycemic:
    codes:
      - ^(?:M|RM)/A10BA02.*  # Metformin
      - ^(?:M|RM)/A10BD02.*
      - ^(?:M|RM)/A10BD03.*
      - ^(?:M|RM)/A10BD05.*
      - ^(?:M|RM)/A10BD07.*
      - ^(?:M|RM)/A10BD08.*
      - ^(?:M|RM)/A10BD10.*
      - ^(?:M|RM)/A10BD11.*
      - ^(?:M|RM)/A10BD13.*
      - ^(?:M|RM)/A10BD18.*
      - ^(?:M|RM)/A10BD20.*
      - ^(?:M|RM)/A10BD22.*
      - ^(?:M|RM)/A10BD23.*
      - ^(?:M|RM)/A10BD25.*
      - ^(?:M|RM)/A10BD26.*
      - ^(?:M|RM)/A10BD27.*
      - ^(?:M|RM)/A10A.*     # Insulin
      - ^(?:M|RM)/A10BB.*    # Sulfonylureas
      - ^(?:M|RM)/A10BD01.*
      - ^(?:M|RM)/A10BD02.*
      - ^(?:M|RM)/A10BD04.*
      - ^(?:M|RM)/A10BD06.*
      - ^(?:M|RM)/A10BH.*    # DPP-4 inhibitors
      - ^(?:M|RM)/A10BD07.*
      - ^(?:M|RM)/A10BD13.*
      - ^(?:M|RM)/A10BD18.*
      - ^(?:M|RM)/A10BD19.*
      - ^(?:M|RM)/A10BD21.*
      - ^(?:M|RM)/A10BD22.*
      - ^(?:M|RM)/A10BD24.*
      - ^(?:M|RM)/A10BD25.*
      - ^(?:M|RM)/A10BD27.*
      - ^(?:M|RM)/A10BJ.*    # GLP-1 agonists
      - ^(?:M|RM)/A10BX04.*
      - ^(?:M|RM)/A10BX07.*
      - ^(?:M|RM)/A10BX10.*
      - ^(?:M|RM)/A10BX13.*
      - ^(?:M|RM)/A10BX14.*
      - ^(?:M|RM)/A10BD03.*  # TZDs
      - ^(?:M|RM)/A10BD06.*
      - ^(?:M|RM)/A10BD09.*
      - ^(?:M|RM)/A10BD12.*
      - ^(?:M|RM)/A10BD26.*
      - ^(?:M|RM)/A10BG.*
    start_days: -60
  # Broad "diabetes" (original): includes T1D + gestational via ICD10; prefer using type2_diabetes below
  diabetes:
    expression: diabetes_icd10 | diabetes_atc_antihyperglycemic | icd10_do24_excluding_do244

  # Recommended T2D-aligned covariate (mirrors cohort)
  type2_diabetes:
    codes:
      - ^(?:D|RD)/DC11.*     # ICD10 T2D
      - ^(?:M|RM)/A10B.*     # non-insulin antidiabetics (optional support)
    start_days: -1826

  ########################################
  # Labs (continuous values as confounders)
  ########################################
  hemoglobin_a1c:
    codes:
      - .*GLOBIN A1C.*
    extract_value: true
    start_days: -90
  # Optional binary aligned with cohort threshold
  hemoglobin_a1c_high:
    codes:
      - .*GLOBIN A1C.*
    threshold: 7.0
    operator: ">="
    start_days: -90

  estimated_glomerular_filtration_rate:
    codes:
      - ^L/.*EGFR.*1[.,]73.*
    extract_value: true
    start_days: -180
  egfr_low:
    codes:
      - ^L/.*EGFR.*1[.,]73.*
    threshold: 60
    operator: "<="
    start_days: -180

  low_density_lipoprotein:
    codes:
      - '^L/KOLESTEROL LDL(?: \(BEREGNET\))?;P(?:\(FPT\))?$'
    extract_value: true
    start_days: -365
  high_density_lipoprotein:
    codes:
      - '^L/KOLESTEROL HDL;P(?:\(FPT\))?$'
    extract_value: true
    start_days: -365
  triglycerides:
    codes:
      - '^L/TRIGLYCERID;P(?:\(FPT\))?$'
    extract_value: true
    start_days: -365

  ########################################
  # CVD history (confounders)
  ########################################
  history_myocardial_infarction:
    codes:
      - ^(?:D|RD)/DI2[1-3].*
    start_days: -1826
  history_stroke_tia:
    codes:
      - ^(?:D|RD)/DI6[3-6].*
      - ^(?:D|RD)/DG45.*
    start_days: -1826
  chronic_coronary_syndrome_stable_angina_pectoris:
    codes:
      - ^(?:D|RD)/DI20[^0].*
      - ^(?:D|RD)/DI251.*
      - ^(?:D|RD)/DI259.*
    start_days: -1826
  arterial_claudication:
